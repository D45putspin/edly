<html>

<head>


    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
    <meta charset="UTF-8">
    <title>EDLY</title>
    <link rel="stylesheet" href="index.css">
    <script type="text/javascript" src="materialize.min.js"></script>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ubuntu:wght@300&display=swap');

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
        }

        footer {

            font-family: 'Nunito', sans-serif;
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: #0e1113;
            color: white;
            text-align: center;
        }

        .nav-extended {
            background-color: #0e1113;
            display: grid;
            justify-content: center;
            align-items: center;
        }

        .nav-wrapper {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 35%;
            height: 35%;
        }

        .logob {
            text-align: center;
        }

        .logob img {
            width: 15%;
            height: 15%;
        }

        hr {
            width: 25%;
        }

        #textoqs {
            font-family: 'Ubuntu', sans-serif;
            font-size: 45px;
            color: #2E2E2E;
            padding-right: 10%;
            padding-left: 10%;
        }

        #contactetitulo {
            font-family: 'Ubuntu', sans-serif;
            font-size: 65px;
            color: #0e1113;
            font-weight: bold;
            padding-left: 17%;
        }

        #contactetexto {
            font-family: 'Ubuntu', sans-serif;
            font-size: 22px;
            color: #2E2E2E;
            padding-left: 13.5%;

        }

        .padding {
            padding-left: 13.5%;
        }

        .col .row {
            margin-right: -0rem !important;
        }

        #mensagem {
            padding-bottom: 15%;
        }


        .navlr {
            position: absolute;
            display: inline-block;
            left: 50px;
            top: 50px;
        }

        .lr {
            font-family: 'Ubuntu', sans-serif;
            color: #f8f8f8;
            font-weight: bold;
        }

        #lr {
            font-family: 'Ubuntu', sans-serif;
            color: #2E2E2E;
            font-weight: bold !important;
        }

        .btn,
        .btn-large,
        .btn-small,
        .btn-flat {
            text-transform: none !important;
        }

        #empresa {
            width: 100%;
            text-align: center;
        }

        .float {

            position: fixed;
            width: 60px;
            height: 60px;
            bottom: 140px;
            right: 140px;
            background-color: slategray;
            color: #FFF;
            border-radius: 50px;
            text-align: center;
            box-shadow: 2px 2px 3px #999;
        }

        .float:hover {
            background-color: rgb(89, 101, 114);
            color: white;
            box-shadow: 4px 4px 5px #999;
            width: 63px;
            height: 63px;
        }

        .my-float {
            margin-top: 22px;
        }

        .rowslojas {
            background-color: blue;
            border: 1px solid black;
        }

        /* The Modal (background) */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            -webkit-animation-name: fadeIn;
            /* Fade in the background */
            -webkit-animation-duration: 0.4s;
            animation-name: fadeIn;
            animation-duration: 0.4s
        }

        /* Modal Content */
        .modal-content {
            font-size: 30px;
            position: fixed;
            bottom: 50%;
            left: 25%;
            background-color: #fefefe;
            width: 50%;
            -webkit-animation-name: slideIn;
            -webkit-animation-duration: 0.4s;
            animation-name: slideIn;
            animation-duration: 0.4s
        }

        /* The Close Button */
        .close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-header {
            padding: 2px 16px;
            background-color: #3E4551;
            color: white;
        }

        .modal-body {
            padding: 2px 16px;
        }

        .modal-footer {
            padding: 2px 16px;
            background-color: #5cb85c;
            color: white;
        }
        .card-image{
    height: 400px; /* Your height here */
    overflow: hidden;
    
}
.card{ height: 500px;}

        /* Add Animation */
        @-webkit-keyframes slideIn {
            from {
                bottom: -300px;
                opacity: 0
            }

            to {
                bottom: 0;
                opacity: 1
            }
        }

        @keyframes slideIn {
            from {
                bottom: -300px;
                opacity: 0
            }

            to {
                bottom: 0;
                opacity: 1
            }
        }

        @-webkit-keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }
    </style>


</head>
<!--<header>
    Navegation bar
    <nav class="nav-extended">
        <div class="navlr">
            <ul>
                <a class="lr" type="button" id="logout" value="logout">logout</a>
                <a class="lr" id="username" href="#"></a>
            </ul>
        </div>
        <div class="nav-wrapper">
            <img class="responsive-img" src="imagens/logo.png">
        </div>

        <div class="nav-content">
            <ul class="tabs tabs-transparent">
                <li class="tab"><a href="#encontrar">Encontrar</a></li>
                <li class="tab"><a href="#quemsomos">Quem Somos?</a></li>
                <li class="tab"><a href="#contacte">Contacte-nos</a></li>
            </ul>
        </div>
    </nav>
</header>-->

<header>
    <!-- Navegation bar-->
    <nav class="nav-extended">
        <div class="navlr">
            <ul>
                <li><a class="lr waves-effect waves-light btn-small #fafafa grey lighten-5" style="color:black;"
                        id="username" href="#"></a></li>
                <li> <a class="lr" type="button" id="logout" value="logout">logout</a></li>


            </ul>
        </div>
        <div class="nav-wrapper">
            <img class="responsive-img" src="imagens/logo.png">
        </div>

        <div class="nav-content">
            <ul class="tabs tabs-transparent">
                <li class="tab"><a href="#encontrar">Encontrar</a></li>
                <li class="tab"><a href="#quemsomos">Quem Somos?</a></li>
                <li class="tab"><a href="#contacte">Contacte-nos</a></li>
            </ul>
        </div>
    </nav>
</header>




<section id="condutor">
    <h1> condutor!!!</h1>
</section>
<section id="cliente">
    <h1> cliente!!!</h1>
</section>







<!-- Currently working section  start date- 30/12/2020 
    what to do: -panel to deny or accept enterprises/workers account creation.
                -create another admin accounts
                -delete  already acepted enterprises
                




-->
<section id="administrador">
    <h1> administrador!!!</h1>
</section>

















<!-- almost done !!!!! 30/12/2020 
    empresas - enterprises
    can add lojas - stores 
    stores can add produtos-products


    falta imagem da store e da empresa se for necessário
    produtos ja com foto a funcionar, codigo em : linha 10/19 produtos.js; 


-->
<section id="empresa">



    <a href="#" id="myBtn" class="float " data-toggle="tooltip" title="adicionar lojas">
        <i class="fa fa-plus my-float"> </i>
    </a>

    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nova Loja</h2>
                <span class="close">&times;</span>

            </div>
            <div class="modal-body">
                <form>
                    <input type=text" placeholder="Nome" id="nome_empresa" name="nome_empresa">
                    <input type=text" placeholder="Tipo de Comida" id="tipo_empresa" name="tipo_empresa">
                    <input type=text" placeholder="Morada" id="morada_empresa" name="morada_empresa">
                    <input type=text" placeholder="Código postal" id="cp_empresa" name="cp_empresa">
                    <input type="button" id="enter_empresa" value="enter">
                </form>
            </div>

        </div>

    </div>
    <div id="myModal1" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <h2>Adicionar Produtos</h2>
                <span class="close1">&times;</span>

            </div>
            <div class="modal-body">
                <form>
                    <input type=text" placeholder="Nome Produto" id="nome_produto" name="nome_produto">
                    <input type=text" placeholder="Preço Produto" id="preco_produto" name="preco_produto">
                    <input type=text" placeholder="Descrição do Produto" id="descricao_produto"
                        name="descricao_produto">
                    <input type="file" id="foto_produto" name="foto_produto" accept="image/png, image/jpeg">
                    <input type="button" id="enter_empresa1" value="enter">
                </form>
            </div>

        </div>

    </div>
    <ul id="lojas">
        <div id="DispNrLojas">
            <h1 id="numerodeloja"> 0 </h1>
            <h2> lojas associadas</h2>
        </div>
        <div class="row " id="row">

        </div>
    </ul>
    <ul id="produtos">
        <div class="row " id="rowprodutos">

        </div>
    </ul>


</section>
<script>
    const urlattime = "localhost:3000";
    let params = (new URL(document.location)).searchParams;
    let loja = params.get("loja");

    $('#enter_empresa1').click(function () {
        var token = document.cookie;
        var tokenrl = token.replace("token=", "");
        let tokendecode = decode(tokenrl);
        var nome_prod = document.getElementById('nome_produto').value;
        var preco_prod = document.getElementById('preco_produto').value;
        var descricao_produto = document.getElementById('descricao_produto').value;
        //appends image (and the other data) to fd so you can send it on data to database 
        var fd = new FormData();
        var file = $('#foto_produto')[0].files[0];
        fd.append('produto_imagem', file);
        fd.append('nome_produto', nome_prod);
        fd.append('tipo', descricao_produto);
        fd.append('id', loja);
        fd.append('id_empresa', tokendecode.id_user)
        fd.append('preco', preco_prod);



        $.ajax({
            url: 'http://' + urlattime + '/produtos/criar-produtos',
            type: 'POST',
            cache: false,
            data: fd,
            headers: { "token": tokenrl },
            contentType: false,
            processData: false,
            success: function (data) {
                console.log(data);


            }
            , error: function (jqXHR, textStatus, err) {
                console.log(err, textStatus);

            }
        })








    })

    $('#enter_empresa').click(function () {
        let nome = nome_empresa.value;
        let tipo = tipo_empresa.value;
        let morada = morada_empresa.value;
        let cod_postal = cp_empresa.value;
        var token = document.cookie;
        var tokenrl = token.replace("token=", "");
        let tokendecode = decode(tokenrl);
        let id = tokendecode.id_user;

        $.ajax({
            url: 'http://' + urlattime + '/loja/inserir_lojas',
            type: 'POST',
            cache: false,
            data: { nome: nome, tipo: tipo, morada: morada, token: tokenrl, id: id, cod_postal: cod_postal },
            headers: { "token": tokenrl },
            success: function (data) {
                window.location.href = "?sucesso=y";

            }
            , error: function (jqXHR, textStatus, err) {

                console.log(err, textStatus);
            }
        })
    });


    if (loja == null) {
//modal adicionar lojas/**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**/
/**/// Get the modal
/**/var modal = document.getElementById("myModal");
/**/
/**/// Get the button that opens the modal
/**/var btn = document.getElementById("myBtn");
/**/
/**/// Get the <span> element that closes the modal
/**/var span = document.getElementsByClassName("close")[0];
/**/
/**/// When the user clicks the button, open the modal 
/**/btn.onclick = function () {
/**/  modal.style.display = "block";
            /**/
        }
/**/
/**/// When the user clicks on <span> (x), close the modal
/**/span.onclick = function () {
/**/  modal.style.display = "none";
            /**/
        }
/**/
/**/// When the user clicks anywhere outside of the modal, close it
/**/window.onclick = function (event) {
/**/  if (event.target == modal) {
/**/    modal.style.display = "none";
                /**/
            }
            /**/
        }
        /**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**/
    }
    else {
//modal editar lojas/**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**/
/**/// Get the modal
/**/var modal = document.getElementById("myModal1");
/**/
/**/// Get the button that opens the modal
/**/var btn = document.getElementById("myBtn");
/**/
/**/// Get the <span> element that closes the modal
/**/var span = document.getElementsByClassName("close1")[0];
/**/
/**/// When the user clicks the button, open the modal 
/**/btn.onclick = function () {
/**/  modal.style.display = "block";
            /**/
        }
/**/
/**/// When the user clicks on <span> (x), close the modal
/**/span.onclick = function () {
/**/  modal.style.display = "none";
            /**/
        }
/**/
/**/// When the user clicks anywhere outside of the modal, close it
/**/window.onclick = function (event) {
/**/  if (event.target == modal) {
/**/    modal.style.display = "none";
                /**/
            }
            /**/
        }
        /**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**//**/


    }
    function verificarloja(token) {
        var json = decode(token);
        var id = json.id_user;
        getnrlojas(id, token);


    }
    function getnrlojas(id, token) {
        var ident = id;
        var tokenrl = token.replace("token=", "");


        $.ajax({
            url: 'http://' + urlattime + '/loja/verificar_lojas/id=' + ident,
            type: 'GET',
            cache: false,
            headers: { "token": tokenrl },



            success: function (data) {

                if (data.message != "sem lojas") {
                    document.getElementById("numerodeloja").innerHTML = data.message;
                    getlojas(ident, token, data.message);
                }

            }
            , error: function (jqXHR, textStatus, err) {

                console.log(err, textStatus)

            }

        })

    }


    function getlojas(id, token, nrlojas) {
        var ident = id;
        var nr = nrlojas
        let params = (new URL(document.location)).searchParams;
        let loja = params.get("loja");
        var tokenrl = token.replace("token=", "");


        $.ajax({
            url: 'http://' + urlattime + '/loja/listar_lojas/id=' + ident,
            type: 'GET',
            cache: false,
            headers: { "token": tokenrl },


            success: function (data) {

                if (data.message != "sem lojas") {
                    var lojas = "" + data.nome;
                    var lojasingular = lojas.split(',');
                    var tipos = "" + data.tipo;
                    var tiposingular = tipos.split(',');
                    var moradas = "" + data.morada;
                    var moradasingular = moradas.split(',');
                    var codigos_postal = "" + data.cp;
                    var cpsingular = codigos_postal.split(',');
                    //verify if header isnt null
                    if (loja != null && loja != "") {
                        console.log("nome" + lojasingular[loja]);
                        $('#lojas').append(`<h1 style="font-size:70px;">${lojasingular[loja - 1]}</h1>`)
                        chamarprodutos(id, token);
                    }
                    else {
                        for (let i = 0; i < nr; i++) {

                            $('#row').append(`<a style="color:white;font-style: normal;"href="?loja=${i + 1}">
                                
                                <div class="col s2 ">
                                <div class="card grey darken-4 center-align">
                                  <div class="card-content white-text">
                                      <span class="card-title" style="font-size:40px;"><h3> ${lojasingular[i]}<h1></span>
                                 </div>
                                 <p style="margin-top:0px;">tipo de comida : ${tiposingular[i]} <br> Morada :${moradasingular[i]}\n <br>${cpsingular[i]}  <p/>
                                </div>
                                </div>
                               <a>`)
                        }
                    }








                }

            }
            , error: function (jqXHR, textStatus, err) {

                console.log(err, textStatus)
            }
        })


    }


    function chamarprodutos(id, token) {
        var ident = id;
        var tokenrl = token.replace("token=", "");
        let params = (new URL(document.location)).searchParams;
        let loja = params.get("loja");


        $.ajax({
            url: 'http://' + urlattime + '/produtos/get-products/id=' + loja,
            type: 'GET',
            cache: false,
            headers: { "token": tokenrl },


            success: function (data) {


                var nomes = data.nome;
                var imagem = data.url;

                var descri = data.descricao;
                var preco = data.preco;
                for (let i = 0; i < nomes.length; i++) {
                    console.log(imagem[i]);
                    $('#DispNrLojas').css("visibility", "hidden");
                    $('#rowprodutos').append(`
                    <a href="?produto=${i + 1}">
                       
    <div class="col s2">
      <div class="card">
        <div class="card-image">
            <img style="height:100%";" src="http://`+urlattime+`/${imagem[i]}">
            <span class="card-title">${nomes[i]}</span>
         
        </div><div class="card-content">
                                  descrição :${descri[i]},preço${preco[i]}  </h3>
                              </div>
                            </div>
                        </div>
                    <a>`)
                }











            }
            , error: function (jqXHR, textStatus, err) {

                console.log(err, textStatus)
            }
        })



    }
    //LOGOUT/**//**//**//**//**//**//**//**//**//**//**//**//**//**/
    $('#logout').click(function () {
        document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC";
    });
    var x = document.cookie;


    function decode(token) {
        var base64Url = x.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        let json = JSON.parse(jsonPayload);
        return json;
    }
    if (x == "") { window.location.href = "../edly/login.html"; }
    let json = decode(x);
    let tipo = json.tipo
    let nome = json.nome;
    console.log("tipo->" + tipo)
    CheckProfile(tipo);



    /*greeting /**//**//**//**//**//**//**//**//**//**//**//**/
    /**/document.getElementById("username").innerHTML = nome;
    /**//**//**//**//**//**//**//**//**//**//**//**//**//**//**/

    /**//**//**//**//**//**//**//**//**//**//**//**//**//**//**/
    function CheckProfile(tipo) {
        var token = document.cookie;
        switch (tipo) {
            case "condutor":

                document.getElementById("cliente").style.display = "none";
                document.getElementById("administrador").style.display = "none";
                document.getElementById("empresa").style.display = "none";
                break;
            case "cliente":

                document.getElementById("condutor").style.display = "none";
                document.getElementById("administrador").style.display = "none";
                document.getElementById("empresa").style.display = "none";
                break;
            case "administrador":

                document.getElementById("cliente").style.display = "none";
                document.getElementById("condutor").style.display = "none";
                document.getElementById("empresa").style.display = "none";
                break;
            case "empresa":

                document.getElementById("cliente").style.display = "none";
                document.getElementById("administrador").style.display = "none";
                document.getElementById("condutor").style.display = "none";
                verificarloja(token);
                break;
        }

    }


    /*function to verify if cookie is set /**//**//**//**/
    setInterval(function () {
        var x = document.cookie;
        if (x == "") {
            console.log("sem cookie")
            window.location.href = "../edly/login.html";

        } else {


        }

    }, 1000);


</script>
<script> M.AutoInit();</script>

</html>